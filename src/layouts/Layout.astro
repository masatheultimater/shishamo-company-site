---
/**
 * Base Layout Component
 * Implements BaseLayoutProps from shared/contracts/components.ts
 *
 * Refactored to use separated Header, MobileNav, Footer components
 * and centralized site configuration from lib/siteConfig.ts
 */
import Header from '../components/layout/Header.astro';
import MobileNav from '../components/layout/MobileNav.astro';
import Footer from '../components/layout/Footer.astro';
import MetaTags from '../components/seo/MetaTags.astro';
import Analytics from '../components/seo/Analytics.astro';
import StructuredData from '../components/seo/StructuredData.astro';
import CookieConsent from '../components/ui/CookieConsent.astro';
import { seoDefaults } from '../lib/siteConfig';

const gtmId = import.meta.env.PUBLIC_GTM_ID;

// BaseLayoutProps interface from contracts/components.ts
interface Props {
  title: string;
  description?: string;
  ogImage?: string;
  ogType?: 'website' | 'article';
  canonicalUrl?: string;
  noIndex?: boolean;
  // Extended props
  keywords?: string[];
  publishedTime?: string;
  modifiedTime?: string;
  // Layout customization
  currentPage?: 'home' | 'services' | 'profile' | 'blog' | 'contact';
  transparentHeader?: boolean;
  showOrganizationSchema?: boolean;
  showPersonSchema?: boolean;
}

const {
  title,
  description = seoDefaults.defaultDescription,
  ogImage,
  ogType = seoDefaults.ogType,
  canonicalUrl,
  noIndex = false,
  keywords,
  publishedTime,
  modifiedTime,
  currentPage,
  transparentHeader = false,
  showOrganizationSchema = true,
  showPersonSchema = false,
} = Astro.props;

// Construct full title with site name
const fullTitle = title.includes(seoDefaults.siteName)
  ? title
  : `${title} | ${seoDefaults.siteName}`;
---

<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- SEO Meta Tags -->
  <MetaTags
    title={fullTitle}
    description={description}
    ogImage={ogImage}
    ogType={ogType}
    canonicalUrl={canonicalUrl}
    noIndex={noIndex}
    keywords={keywords}
    publishedTime={publishedTime}
    modifiedTime={modifiedTime}
  />

  <!-- Fonts: Inter + Noto Sans JP -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;900&family=Inter:wght@400;500;600;700;900&display=swap"
    rel="stylesheet"
  >

  <!-- Title -->
  <title>{fullTitle}</title>

  <!-- Favicon -->
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="/favicon-32x32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="/favicon-16x16.png" sizes="16x16" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">

  <!-- RSS Autodiscovery -->
  <link rel="alternate" type="application/rss+xml" title="ブログ | ししゃもカンパニー" href="/blog/rss.xml">

  <!-- Preload hero background -->
  <link rel="preload" as="image" type="image/webp" href="/wp1.webp">

  <!-- Google Tag Manager -->
  <Analytics />

  <!-- Structured Data -->
  {showOrganizationSchema && <StructuredData type="Organization" />}
  {showPersonSchema && <StructuredData type="Person" />}

  <!-- Theme Initialization (prevents flash of unstyled content) -->
  <script is:inline>
    (function() {
      var stored = localStorage.getItem('theme-preference');
      if (stored === 'light' || stored === 'dark') {
        document.documentElement.setAttribute('data-theme', stored);
      } else {
        var isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
      }
    })();
  </script>

  <!-- Additional head content slot -->
  <slot name="head" />
</head>
<body>
  {/* GTM noscript fallback */}
  {import.meta.env.PROD && gtmId && (
    <noscript><iframe src={`https://www.googletagmanager.com/ns.html?id=${gtmId}`} height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  )}

  <!-- Skip to main content link for accessibility -->
  <a href="#main-content" class="skip-link">メインコンテンツへスキップ</a>

  <!-- Header with navigation -->
  <Header currentPage={currentPage} transparent={transparentHeader} />

  <!-- Mobile navigation overlay -->
  <MobileNav />

  <!-- Main content -->
  <main id="main-content">
    <slot />
  </main>

  <!-- Footer -->
  <Footer />

  <!-- Cookie Consent Banner -->
  <CookieConsent />

  <!-- GTM: Global analytics (scroll, engagement, CTA clicks) -->
  <script>
    import { initScrollTracking, initEngagementTracking, trackCTAClick } from '../lib/analytics';

    initScrollTracking();
    initEngagementTracking();

    document.querySelectorAll<HTMLAnchorElement>('[data-track-cta]').forEach(el => {
      el.addEventListener('click', (e) => {
        e.preventDefault();
        trackCTAClick({
          cta_location: el.dataset.trackCta || 'unknown',
          cta_text: el.textContent?.trim() || '',
          destination_url: el.href,
        }, el.href);
      });
    });
  </script>
</body>
</html>

<style is:global>
  @import '../styles/global.css';

  /* Skip link for accessibility */
  .skip-link {
    position: absolute;
    top: 0;
    left: 0;
    background: var(--primary);
    color: white;
    padding: var(--space-sm) var(--space-md);
    z-index: 1000;
    transform: translateY(-100%);
    transition: transform 0.3s;
  }

  .skip-link:focus {
    transform: translateY(0);
  }
</style>
