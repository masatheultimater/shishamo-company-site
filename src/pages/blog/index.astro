---
import Layout from '../../layouts/Layout.astro';
import StructuredData from '../../components/seo/StructuredData.astro';
import {
  getAllBlogPosts,
  categoryLabels,
  categoryIcons,
  getPrimaryCategory,
  formatDate,
  transformBlogPost,
} from '../../lib/microcms';
import type { BlogCategory } from '@shared/contracts/api';
import { Icon } from 'astro-icon/components';
import { siteMetadata } from '../../lib/siteConfig';
import '../../styles/blog.css';

const allPosts = await getAllBlogPosts();
const posts = allPosts.map(transformBlogPost);

// Build category counts for nav
const categoryCounts: Record<string, number> = {};
for (const post of posts) {
  const cat = getPrimaryCategory(post.category);
  categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
}

const categories = Object.keys(categoryLabels) as BlogCategory[];
---

<Layout
  title="ブログ | ししゃもカンパニー"
  description="IT・経営・会計の「で、うちはどうすればいい？」に答えるブログ。個人事業主・中小企業の方に向けて、わかりやすく書いています。"
  currentPage="blog"
>
  <StructuredData
    slot="head"
    type="CollectionPage"
    data={{
      name: 'ブログ',
      url: `${siteMetadata.siteUrl}/blog/`,
      description:
        'IT・経営・会計の「で、うちはどうすればいい？」に答えるブログ。',
    }}
  />

  <section class="page-header">
    <h1>ブログ</h1>
    <p>「で、うちはどうすればいい？」に答える記事を書いています</p>
  </section>

  <nav class="blog-nav" aria-label="ブログカテゴリナビゲーション">
    <div class="blog-nav-inner" role="tablist">
      <a href="#all" class="active" role="tab" aria-selected="true">
        すべて<span class="sr-only">の記事</span>
      </a>
      {
        categories.map((cat) => (
          <a
            href={`#${cat}`}
            role="tab"
            aria-selected="false"
            data-category={cat}
          >
            <Icon name={categoryIcons[cat]} size={14} aria-hidden="true" />
            {categoryLabels[cat]}
          </a>
        ))
      }
    </div>
  </nav>

  <div class="blog-grid" id="blog-grid">
    {
      posts.length === 0 ? (
        <div class="blog-empty">
          <p>まだ記事がありません</p>
          <p>ただいま準備中です。もう少しお待ちください。</p>
        </div>
      ) : (
        posts.map((post) => {
          const cat = getPrimaryCategory(post.category);
          return (
            <a
              href={`/blog/${post.slug || post.id}/`}
              class="blog-card"
              data-category={cat}
            >
              <div class="blog-card__meta">
                <span class="blog-card__category">{categoryLabels[cat]}</span>
                <time datetime={post.publishedAt}>
                  {formatDate(post.publishedAt)}
                </time>
              </div>
              <h2 class="blog-card__title">{post.title}</h2>
              {post.excerpt && <p class="blog-card__excerpt">{post.excerpt}</p>}
              {post.tags && post.tags.length > 0 && (
                <div class="blog-card__tags">
                  {post.tags.slice(0, 3).map((tag) => (
                    <span class="blog-card__tag">#{tag}</span>
                  ))}
                </div>
              )}
            </a>
          );
        })
      )
    }
  </div>
</Layout>

<script>
  // Client-side category filtering
  const nav = document.querySelector('.blog-nav-inner');
  const cards = document.querySelectorAll<HTMLElement>('.blog-card');

  if (nav && cards.length > 0) {
    nav.addEventListener('click', (e) => {
      const target = (e.target as HTMLElement).closest('a');
      if (!target) return;
      e.preventDefault();

      // Update active tab
      nav.querySelectorAll('a').forEach((a) => {
        a.classList.remove('active');
        a.setAttribute('aria-selected', 'false');
      });
      target.classList.add('active');
      target.setAttribute('aria-selected', 'true');

      const category = target.getAttribute('href')?.replace('#', '');

      cards.forEach((card) => {
        if (category === 'all' || card.dataset.category === category) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });

      // Update URL hash without scroll
      history.replaceState(null, '', `#${category}`);
    });

    // Handle initial hash
    const hash = window.location.hash.replace('#', '');
    if (hash && hash !== 'all') {
      const tab = nav.querySelector(`a[href="#${hash}"]`) as HTMLElement;
      if (tab) tab.click();
    }
  }
</script>
