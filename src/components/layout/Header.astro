---
/**
 * Header Component
 * Implements HeaderProps from shared/contracts/components.ts
 */
import {
  siteBranding,
  navigationItems,
  socialLinks,
} from '../../lib/siteConfig';
import Logo from '../ui/Logo.astro';
import XIcon from '../ui/XIcon.astro';
import { Icon } from 'astro-icon/components';

interface Props {
  currentPage?: 'home' | 'services' | 'profile' | 'blog' | 'contact';
  transparent?: boolean;
}

const { currentPage, transparent = false } = Astro.props;
---

<header class:list={['header', { 'header--transparent': transparent }]}>
  <div class="header-inner">
    <div class="logo-group">
      <a href="/" class="logo">
        <div class="logo-mark">
          <Logo />
        </div>
        <div class="logo-text">SHISHAMO COMPANY</div>
      </a>
      <a
        href={socialLinks.x.url}
        target="_blank"
        rel="noopener noreferrer"
        class="header-social-link header-x-link"
        aria-label={socialLinks.x.label}
      >
        <XIcon size={14} />
      </a>
    </div>

    <nav class="nav" aria-label="Main navigation">
      {
        navigationItems.map((item) => (
          <a
            href={item.href}
            class:list={[
              'nav-link',
              { 'nav-link--active': currentPage === item.slug },
            ]}
          >
            {item.title}
          </a>
        ))
      }
      <a
        href="/contact/"
        class:list={[
          'nav-cta',
          { 'nav-cta--active': currentPage === 'contact' },
        ]}
      >
        無料相談
      </a>
      <button class="theme-toggle" id="themeToggle" aria-label="テーマ切り替え">
        <Icon
          name="ri:sun-line"
          class="theme-icon theme-icon--light"
          size={18}
        />
        <Icon
          name="ri:moon-line"
          class="theme-icon theme-icon--dark"
          size={18}
        />
      </button>
      <div class="font-size-control" role="group" aria-label="文字サイズ調整">
        <span class="font-size-label" aria-hidden="true">文字</span>
        <button
          class="font-size-btn"
          data-font-size-level="small"
          aria-label="文字サイズ: 小（標準）"
          aria-pressed="true"
        >
          <span class="font-size-btn__text font-size-btn__text--small">小</span>
        </button>
        <button
          class="font-size-btn"
          data-font-size-level="medium"
          aria-label="文字サイズ: 中"
          aria-pressed="false"
        >
          <span class="font-size-btn__text font-size-btn__text--medium">中</span
          >
        </button>
        <button
          class="font-size-btn"
          data-font-size-level="large"
          aria-label="文字サイズ: 大"
          aria-pressed="false"
        >
          <span class="font-size-btn__text font-size-btn__text--large">大</span>
        </button>
        <button
          class="font-size-btn"
          data-font-size-level="xlarge"
          aria-label="文字サイズ: 特大"
          aria-pressed="false"
        >
          <span class="font-size-btn__text font-size-btn__text--xlarge"
            >特大</span
          >
        </button>
      </div>
    </nav>

    <div class="header-actions">
      <a
        href={socialLinks.x.url}
        target="_blank"
        rel="noopener noreferrer"
        class="header-actions__x-link"
        aria-label={socialLinks.x.label}
      >
        <XIcon size={16} />
      </a>
      <div class="font-size-wrapper">
        <button
          class="font-size-toggle"
          id="fontSizeToggle"
          aria-label="文字サイズを変更"
          aria-haspopup="true"
          aria-expanded="false"
        >
          <span class="font-size-toggle__text">Aa</span>
        </button>
        <div
          class="font-size-popover"
          id="fontSizePopover"
          role="group"
          aria-label="文字サイズ選択"
          hidden
        >
          <span class="font-size-popover__label">文字サイズ</span>
          <div class="font-size-popover__buttons">
            <button
              class="font-size-btn"
              data-font-size-level="small"
              aria-label="文字サイズ: 小（標準）"
              aria-pressed="true"
            >
              <span class="font-size-btn__text font-size-btn__text--small"
                >小</span
              >
            </button>
            <button
              class="font-size-btn"
              data-font-size-level="medium"
              aria-label="文字サイズ: 中"
              aria-pressed="false"
            >
              <span class="font-size-btn__text font-size-btn__text--medium"
                >中</span
              >
            </button>
            <button
              class="font-size-btn"
              data-font-size-level="large"
              aria-label="文字サイズ: 大"
              aria-pressed="false"
            >
              <span class="font-size-btn__text font-size-btn__text--large"
                >大</span
              >
            </button>
            <button
              class="font-size-btn"
              data-font-size-level="xlarge"
              aria-label="文字サイズ: 特大"
              aria-pressed="false"
            >
              <span class="font-size-btn__text font-size-btn__text--xlarge"
                >特大</span
              >
            </button>
          </div>
        </div>
      </div>
      <button
        class="theme-toggle theme-toggle--mobile"
        id="themeToggleMobile"
        aria-label="テーマ切り替え"
      >
        <Icon
          name="ri:sun-line"
          class="theme-icon theme-icon--light"
          size={18}
        />
        <Icon
          name="ri:moon-line"
          class="theme-icon theme-icon--dark"
          size={18}
        />
      </button>
      <button
        class="mobile-menu-btn"
        aria-label="メニューを開く"
        aria-expanded="false"
        aria-controls="mobileNav"
        id="mobileMenuBtn"
      >
        <Icon name="ri:menu-line" size={20} />
      </button>
    </div>
  </div>
</header>

<style>
  /* ===== HEADER — Glass Navbar ===== */
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background: var(--color-glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--color-glass-border);
    padding: 0 24px;
  }

  .header--transparent {
    background: transparent;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border-bottom: none;
  }

  .header-inner {
    max-width: var(--container-lg);
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-height: 72px;
  }

  /* Logo Group */
  .logo-group {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .logo {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    min-width: 0;
  }

  .logo-mark {
    width: 64px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-heading);
  }

  .logo-mark :global(svg) {
    width: 100%;
    height: 100%;
  }

  .logo-text {
    font-family: var(--font-logo);
    font-weight: 600;
    font-size: 9px;
    letter-spacing: 0.18em;
    color: var(--color-text-heading);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }

  /* Social Links (desktop, in logo-group) */
  .header-social-link {
    width: 32px;
    height: 32px;
    background: var(--color-surface-elevated);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: var(--color-text-secondary);
    transition: all var(--transition-base);
  }

  .header-social-link.header-x-link {
    background: var(--color-text-heading);
    color: var(--color-bg);
  }

  .header-social-link:hover {
    background: var(--color-accent);
    color: var(--palette-white);
  }

  .header-social-link:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  /* Mobile X link (in header-actions, hidden on desktop) */
  .header-actions__x-link {
    display: none;
    width: 44px;
    height: 44px;
    background: var(--color-text-heading);
    color: var(--color-bg);
    border-radius: var(--radius-sm);
    align-items: center;
    justify-content: center;
    transition: all var(--transition-base);
  }

  .header-actions__x-link:hover {
    background: var(--color-accent);
    color: var(--palette-white);
  }

  .header-actions__x-link:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  /* Navigation */
  .nav {
    display: flex;
    align-items: center;
    gap: 28px;
  }

  .nav-link {
    font-size: 14px;
    font-weight: 500;
    color: var(--color-text-secondary);
    transition: color var(--transition-base);
    padding: 8px 0;
  }

  .nav-link:hover,
  .nav-link--active {
    color: var(--color-text-heading);
  }

  .nav-cta {
    background: var(--gradient-semantic-primary);
    color: var(--palette-white);
    padding: 10px 20px;
    border-radius: var(--radius-md);
    font-size: 14px;
    font-weight: 600;
    transition: all var(--transition-base);
  }

  .nav-cta:hover {
    box-shadow: var(--color-btn-primary-hover-shadow);
  }

  /* Theme Toggle */
  .theme-toggle {
    background: var(--color-surface-elevated);
    border: none;
    width: 44px;
    height: 44px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background var(--transition-base);
    position: relative;
  }

  .theme-toggle:hover {
    background: var(--color-surface-hover);
  }

  .theme-icon {
    position: absolute;
    transition:
      opacity var(--transition-base),
      transform var(--transition-base);
    color: var(--color-text-secondary);
  }

  .theme-icon--light {
    opacity: 1;
    transform: scale(1);
  }

  .theme-icon--dark {
    opacity: 0;
    transform: scale(0.8);
  }

  :global([data-theme='light']) .theme-icon--light {
    opacity: 1;
    transform: scale(1);
  }

  :global([data-theme='light']) .theme-icon--dark {
    opacity: 0;
    transform: scale(0.8);
  }

  :global([data-theme='dark']) .theme-icon--light {
    opacity: 0;
    transform: scale(0.8);
  }

  :global([data-theme='dark']) .theme-icon--dark {
    opacity: 1;
    transform: scale(1);
  }

  .theme-toggle--mobile {
    display: none;
  }

  /* Font Size Control */
  .font-size-control {
    display: flex;
    align-items: center;
    gap: 2px;
    border-left: 1px solid var(--color-border-subtle);
    padding-left: 12px;
    margin-left: 4px;
  }

  .font-size-label {
    font-size: 11px;
    color: var(--color-text-muted);
    user-select: none;
    margin-right: 4px;
  }

  .font-size-btn {
    background: transparent;
    border: 1px solid transparent;
    min-width: 32px;
    height: 32px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-base);
    color: var(--color-text-secondary);
  }

  .font-size-btn:hover {
    background: var(--color-surface-hover);
    color: var(--color-text-heading);
  }

  .font-size-btn:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 1px;
  }

  .font-size-btn--active {
    background: var(--color-accent-subtle);
    color: var(--color-accent);
    border-color: var(--color-accent);
  }

  /* Button text sizes in px (must NOT self-scale) */
  .font-size-btn__text--small {
    font-size: 11px;
  }
  .font-size-btn__text--medium {
    font-size: 13px;
  }
  .font-size-btn__text--large {
    font-size: 15px;
  }
  .font-size-btn__text--xlarge {
    font-size: 17px;
  }

  .font-size-btn__text {
    font-weight: 600;
    line-height: 1;
  }

  /* Font Size Popover (mobile only) */
  .font-size-wrapper {
    display: none;
    position: relative;
  }

  .font-size-toggle {
    width: 44px;
    height: 44px;
    background: var(--color-surface-elevated);
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background var(--transition-base);
  }

  .font-size-toggle:hover {
    background: var(--color-surface-hover);
  }

  .font-size-toggle:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  .font-size-toggle__text {
    font-size: 16px;
    font-weight: 700;
    color: var(--color-text-secondary);
    line-height: 1;
  }

  .font-size-popover {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    z-index: 102;
    background: var(--color-surface-elevated);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-semantic-lg);
    padding: 12px 16px;
    opacity: 1;
    transform: translateY(0);
    transition:
      opacity 0.2s ease,
      transform 0.2s ease;
  }

  .font-size-popover[hidden] {
    display: block;
    opacity: 0;
    transform: translateY(-8px);
    pointer-events: none;
    visibility: hidden;
  }

  .font-size-popover__label {
    display: block;
    font-size: 11px;
    color: var(--color-text-muted);
    margin-bottom: 8px;
    user-select: none;
    white-space: nowrap;
  }

  .font-size-popover__buttons {
    display: flex;
    gap: 4px;
  }

  .font-size-popover .font-size-btn {
    min-width: 48px;
    height: 48px;
  }

  /* Header Actions */
  .header-actions {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Mobile Menu Button */
  .mobile-menu-btn {
    display: none;
    background: var(--color-surface-elevated);
    border: none;
    width: 44px;
    height: 44px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    color: var(--color-text-secondary);
    align-items: center;
    justify-content: center;
    transition: background var(--transition-base);
  }

  .mobile-menu-btn:hover {
    background: var(--color-surface-hover);
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 768px) {
    .header-inner {
      min-height: 64px;
    }

    .nav {
      display: none;
    }

    .mobile-menu-btn {
      display: flex;
    }

    .theme-toggle--mobile {
      display: flex;
    }

    .header-social-link {
      display: none;
    }

    .header-actions__x-link {
      display: flex;
    }

    .font-size-control {
      display: none;
    }

    .font-size-wrapper {
      display: block;
    }
  }

  @media (max-width: 480px) {
    .header {
      padding: 0 16px;
    }

    .logo-mark {
      width: 54px;
      height: 35px;
    }

    .logo-text {
      font-size: 8px;
    }

    .logo-group {
      gap: 10px;
    }
  }
</style>

<script>
  import '../../scripts/theme';
  import '../../scripts/fontSize';

  function initFontSizePopover() {
    const toggle = document.getElementById('fontSizeToggle');
    const popover = document.getElementById('fontSizePopover');
    if (!toggle || !popover) return;

    function openPopover() {
      popover!.removeAttribute('hidden');
      toggle!.setAttribute('aria-expanded', 'true');
    }

    function closePopover() {
      popover!.setAttribute('hidden', '');
      toggle!.setAttribute('aria-expanded', 'false');
    }

    function isOpen() {
      return !popover!.hasAttribute('hidden');
    }

    toggle.addEventListener('click', (e) => {
      e.stopPropagation();
      if (isOpen()) {
        closePopover();
      } else {
        openPopover();
      }
    });

    document.addEventListener('click', (e) => {
      if (isOpen() && !popover!.contains(e.target as Node)) {
        closePopover();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen()) {
        closePopover();
        toggle!.focus();
      }
    });

    popover.querySelectorAll('.font-size-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        setTimeout(closePopover, 100);
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFontSizePopover);
  } else {
    initFontSizePopover();
  }
</script>
